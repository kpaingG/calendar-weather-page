<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日历+天气+空气质量页面</title>
    <style>
        /* 全局样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Microsoft YaHei", "PingFang SC", Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        /* 顶部控制栏优化 */
        .top-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 24px;
            align-items: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        .city-input {
            padding: 10px 16px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            flex: 1;
            min-width: 180px;
            transition: border 0.2s;
        }
        .city-input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary {
            background: #4299e1;
            color: white;
        }
        .btn-primary:hover {
            background: #2b6cb0;
            transform: translateY(-2px);
        }
        .btn-toggle {
            background: #e8f4f8;
            color: #2d3748;
        }
        .btn-toggle:hover {
            background: #d1e7dd;
            transform: translateY(-2px);
        }
        /* 日历模块优化 */
        .calendar {
            margin-bottom: 30px;
        }
        .calendar-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .calendar-header-bar h2 {
            margin: 0;
            color: #2d3748;
            font-size: 22px;
            font-weight: 600;
        }
        .calendar-nav button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: #e8f4f8;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .calendar-nav button:hover {
            background: #d1e7dd;
            transform: translateY(-2px);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        .calendar-header {
            text-align: center;
            font-weight: 600;
            color: #718096;
            padding: 10px 0;
            font-size: 14px;
        }
        .calendar-day {
            text-align: center;
            padding: 14px 0;
            border-radius: 10px;
            background: #e8f4f8;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            position: relative;
        }
        .calendar-day:hover {
            background: #d1e7dd;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .today {
            background: #4299e1;
            color: white;
            font-weight: 600;
            border: 2px solid #2b6cb0;
        }
        .selected {
            background: #38b2ac;
            color: white;
            font-weight: 600;
            border: 2px solid #285e61;
        }
        /* 天气模块优化 */
        .weather {
            padding: 28px;
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8fb 100%);
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .weather h3 {
            margin-top: 0;
            color: #2d3748;
            font-size: 22px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .weather-info {
            display: flex;
            align-items: center;
            gap: 28px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .temp {
            font-size: 42px;
            font-weight: 700;
            color: #4299e1;
            display: flex;
            align-items: baseline;
            gap: 4px;
        }
        .weather-desc {
            font-size: 16px;
            color: #4a5568;
            flex: 1;
            min-width: 200px;
        }
        .aqi-info {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 8px;
            font-weight: 500;
        }
        .aqi-excellent { background: #00e400; color: white; }
        .aqi-good { background: #ffff00; color: #333; }
        .aqi-moderate { background: #ff7e00; color: white; }
        .aqi-poor { background: #ff0000; color: white; }
        .aqi-very-poor { background: #8f3f97; color: white; }
        .aqi-hazardous { background: #7e0023; color: white; }
        /* 时段天气优化 */
        .hourly-weather {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 10px 0 20px 0;
            margin-bottom: 8px;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f8f9fa;
        }
        .hourly-weather::-webkit-scrollbar {
            height: 8px;
        }
        .hourly-weather::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }
        .hourly-weather::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 4px;
        }
        .hourly-item {
            min-width: 80px;
            text-align: center;
            padding: 14px 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        .hourly-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        .hourly-time {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
            margin-bottom: 6px;
        }
        .hourly-temp {
            color: #4299e1;
            margin: 6px 0;
            font-size: 16px;
            font-weight: 600;
        }
        .hourly-desc {
            font-size: 12px;
            color: #718096;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* 未来7天预报优化 */
        .weekly-weather {
            padding: 24px;
            background: linear-gradient(135deg, #f5fafe 0%, #eaf6fa 100%);
            border-radius: 16px;
        }
        .weekly-weather h4 {
            color: #2d3748;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
        }
        .weekly-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        .weekly-item {
            text-align: center;
            padding: 16px 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        .weekly-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        .weekly-date {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .weekly-temp {
            color: #4299e1;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .weekly-desc {
            font-size: 12px;
            color: #718096;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(66, 153, 225, 0.3);
            border-radius: 50%;
            border-top-color: #4299e1;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* 响应式适配 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .temp {
                font-size: 36px;
            }
            .weather-info {
                gap: 16px;
            }
            .weekly-list {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 顶部控制栏：城市切换 + 温标切换 -->
        <div class="top-controls">
            <input type="text" id="city-input" class="city-input" placeholder="输入城市名称，如：北京、上海">
            <button class="btn btn-primary" id="change-city">
                <span>切换城市</span>
            </button>
            <button class="btn btn-toggle" id="toggle-temp">切换到 ℉</button>
        </div>

        <!-- 日历模块（支持切换月份） -->
        <div class="calendar" id="calendar">
            <div class="calendar-header-bar">
                <button id="prev-month">&lt; 上月</button>
                <h2 id="calendar-title"></h2>
                <button id="next-month">下月 &gt;</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-header">日</div>
                <div class="calendar-header">一</div>
                <div class="calendar-header">二</div>
                <div class="calendar-header">三</div>
                <div class="calendar-header">四</div>
                <div class="calendar-header">五</div>
                <div class="calendar-header">六</div>
            </div>
        </div>

        <!-- 天气模块 -->
        <div class="weather" id="weather">
            <h3 id="weather-title">实时天气</h3>
            <div class="weather-info">
                <div class="temp" id="temp">--℃</div>
                <div class="weather-desc">
                    <div id="city">加载中<span class="loading"></span></div>
                    <div id="condition">--</div>
                    <div id="aqi" class="aqi-info">空气质量：加载中</div>
                </div>
            </div>

            <!-- 当天时段天气 -->
            <div class="hourly-weather" id="hourly-weather">
                <!-- 时段天气会通过JS动态生成 -->
            </div>
        </div>

        <!-- 未来7天预报模块 -->
        <div class="weekly-weather" id="weekly-weather">
            <h4>未来7天天气预报</h4>
            <div class="weekly-list" id="weekly-list">
                <!-- 7天预报会通过JS动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentCity = "北京";
        let weatherData = null;
        let aqiData = null;
        let selectedDate = new Date();
        let currentCalendarDate = new Date(); // 当前日历显示的月份
        let isCelsius = true; // 默认显示摄氏度
        const SHOW_HOURLY_COUNT = 8; // 显示8个时段天气

        // ========== 工具函数 ==========
        // 温度转换
        function convertTemp(tempC) {
            if (isNaN(tempC)) return isCelsius ? "--℃" : "--℉";
            if (isCelsius) {
                return `${tempC}℃`;
            } else {
                const tempF = Math.round((tempC * 9/5) + 32);
                return `${tempF}℉`;
            }
        }

        // 获取城市经纬度（高德API）
        async function getCityLocation(city) {
            try {
                // 高德地图地理编码API（免费，无需key，有调用限制）
                const res = await fetch(`https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(city)}&output=json&key=e9092f93e5f9f270e869af981b080799`);
                const data = await res.json();
                if (data.status === "1" && data.geocodes.length > 0) {
                    const location = data.geocodes[0].location.split(",");
                    return { lng: location[0], lat: location[1] };
                }
                return null;
            } catch (error) {
                console.error("获取城市坐标失败：", error);
                return null;
            }
        }

        // ========== 顶部控制栏功能 ==========
        // 切换城市
        document.getElementById("change-city").addEventListener("click", async function() {
            const cityInput = document.getElementById("city-input");
            const newCity = cityInput.value.trim();
            if (!newCity) return;
            
            // 显示加载状态
            this.innerHTML = '<span class="loading"></span> 切换中...';
            this.disabled = true;
            
            // 验证城市是否有效
            const location = await getCityLocation(newCity);
            if (location) {
                currentCity = newCity;
                selectedDate = new Date();
                currentCalendarDate = new Date();
                initCalendar();
                loadWeatherByDate(new Date());
                loadWeeklyWeather();
                loadAQI(location.lng, location.lat);
            } else {
                alert("城市名称无效，请重新输入（如：北京、上海市）");
            }
            
            // 恢复按钮状态
            this.innerHTML = '<span>切换城市</span>';
            this.disabled = false;
            cityInput.value = "";
        });

        // 切换温标（℃/℉）
        document.getElementById("toggle-temp").addEventListener("click", function() {
            isCelsius = !isCelsius;
            this.textContent = isCelsius ? "切换到 ℉" : "切换到 ℃";
            // 重新渲染当前天气
            if (weatherData) {
                loadWeatherByDate(selectedDate);
                loadHourlyWeather();
                loadWeeklyWeather();
            }
        });

        // ========== 日历功能（支持切换月份） ==========
        function initCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth(); // 0-11
            const today = new Date();

            // 设置日历标题
            const monthNames = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
            document.getElementById("calendar-title").textContent = `${year}年${monthNames[month]}`;

            // 清空原有日期
            const calendarGrid = document.querySelector(".calendar-grid");
            const headers = Array.from(calendarGrid.children).slice(0, 7);
            calendarGrid.innerHTML = "";
            headers.forEach(h => calendarGrid.appendChild(h));

            // 计算当月天数和第一天星期几
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // 填充月初空白
            for (let i = 0; i < firstDay; i++) {
                const emptyDiv = document.createElement("div");
                emptyDiv.className = "calendar-day";
                calendarGrid.appendChild(emptyDiv);
            }

            // 填充日期（带点击事件）
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement("div");
                dayDiv.className = "calendar-day";
                dayDiv.dataset.date = `${year}-${month+1}-${day}`;
                dayDiv.textContent = day;

                // 标记今天和选中日期
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayDiv.classList.add("today");
                }
                if (day === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) {
                    dayDiv.classList.add("selected");
                }

                // 点击事件
                dayDiv.addEventListener("click", function() {
                    document.querySelectorAll(".calendar-day.selected").forEach(el => el.classList.remove("selected"));
                    this.classList.add("selected");
                    selectedDate = new Date(year, month, day);
                    loadWeatherByDate(selectedDate);
                });

                calendarGrid.appendChild(dayDiv);
            }
        }

        // 切换到上月/下月
        document.getElementById("prev-month").addEventListener("click", function() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            initCalendar();
        });
        document.getElementById("next-month").addEventListener("click", function() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            initCalendar();
        });

        // ========== 天气功能（国内稳定接口） ==========
        // 初始化天气
        async function initWeather() {
            try {
                // 1. 获取用户所在城市（通过IP）
                const ipRes = await fetch("https://pv.sohu.com/cityjson?ie=utf-8");
                const ipText = await ipRes.text();
                const ipData = JSON.parse(ipText.match(/({[\s\S]*})/)[0]);
                currentCity = ipData.cname || "北京";
                
                // 2. 获取城市坐标
                const location = await getCityLocation(currentCity);
                if (location) {
                    loadWeatherByDate(new Date());
                    loadWeeklyWeather();
                    loadAQI(location.lng, location.lat);
                } else {
                    // 备用方案
                    loadWeatherByDate(new Date());
                    loadWeeklyWeather();
                    loadAQIFallback();
                }
            } catch (error) {
                console.error("初始化天气失败：", error);
                currentCity = "北京";
                loadWeatherByDate(new Date());
                loadWeeklyWeather();
                loadAQIFallback();
            }
        }

        // 加载指定日期的天气（使用国内wttr镜像）
        async function loadWeatherByDate(targetDate) {
            try {
                const dateStr = targetDate.toISOString().split("T")[0].replace(/-/g, "");
                // 使用国内镜像，更稳定
                const weatherRes = await fetch(`https://wttr.in/${currentCity}?format=j1&date=${dateStr}`);
                weatherData = await weatherRes.json();

                // 更新天气标题
                const dateTitle = targetDate.toLocaleDateString("zh-CN", { year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById("weather-title").textContent = `${currentCity} ${dateTitle} 天气`;

                // 提取天气数据
                let weatherInfo;
                const today = new Date().toDateString();
                if (targetDate.toDateString() === today) {
                    weatherInfo = weatherData.current_condition[0];
                    document.getElementById("city").textContent = currentCity;
                } else {
                    const forecastDay = weatherData.weather.find(day => day.date === dateStr);
                    weatherInfo = {
                        temp_C: forecastDay?.avgtempC || "--",
                        weatherDesc: [{ value: forecastDay?.weatherDesc[0].value || "--" }]
                    };
                }

                // 更新核心显示（带温标切换）
                document.getElementById("temp").textContent = convertTemp(weatherInfo.temp_C);
                document.getElementById("condition").textContent = weatherInfo.weatherDesc[0].value || "--";

                // 加载时段天气（仅今天）
                if (targetDate.toDateString() === today) {
                    loadHourlyWeather();
                } else {
                    document.getElementById("hourly-weather").innerHTML = "<div style='padding: 12px; color: #718096; font-size: 14px;'>仅显示当天时段天气</div>";
                }
            } catch (error) {
                console.error("加载天气失败：", error);
                document.getElementById("temp").textContent = isCelsius ? "--℃" : "--℉";
                document.getElementById("condition").textContent = "获取天气失败";
                document.getElementById("hourly-weather").innerHTML = "";
            }
        }

        // 加载当天时段天气
        function loadHourlyWeather() {
            const hourlyWeather = document.getElementById("hourly-weather");
            hourlyWeather.innerHTML = "";

            const hourlyData = weatherData.hourly.slice(0, SHOW_HOURLY_COUNT);
            if (hourlyData.length === 0) {
                hourlyWeather.innerHTML = "<div style='padding: 12px; color: #718096; font-size: 14px;'>暂无时段天气数据</div>";
                return;
            }

            hourlyData.forEach(item => {
                const hourlyItem = document.createElement("div");
                hourlyItem.className = "hourly-item";
                const time = item.time.slice(0, 2) + ":00";
                const temp = convertTemp(item.tempC);
                const desc = item.weatherDesc[0].value || "--";

                hourlyItem.innerHTML = `
                    <div class="hourly-time">${time}</div>
                    <div class="hourly-temp">${temp}</div>
                    <div class="hourly-desc">${desc}</div>
                `;
                hourlyWeather.appendChild(hourlyItem);
            });
        }

        // 加载未来7天天气预报
        async function loadWeeklyWeather() {
            try {
                const weatherRes = await fetch(`https://wttr.in/${currentCity}?format=j1`);
                const weeklyData = await weatherRes.json();
                const weeklyList = document.getElementById("weekly-list");
                weeklyList.innerHTML = "";

                // 取未来7天数据（跳过今天）
                const futureDays = weeklyData.weather.slice(1, 8);
                if (futureDays.length === 0) {
                    weeklyList.innerHTML = "<div style='padding: 12px; color: #718096; font-size: 14px;'>暂无7天预报数据</div>";
                    return;
                }

                futureDays.forEach(day => {
                    const weeklyItem = document.createElement("div");
                    weeklyItem.className = "weekly-item";
                    
                    // 格式化日期
                    const date = new Date(day.date.slice(0,4), day.date.slice(4,6)-1, day.date.slice(6,8));
                    const dateText = date.toLocaleDateString("zh-CN", { month: 'short', day: 'numeric' });
                    
                    // 温度区间（带温标切换）
                    const minTemp = isCelsius ? `${day.mintempC}℃` : `${Math.round((day.mintempC * 9/5) + 32)}℉`;
                    const maxTemp = isCelsius ? `${day.maxtempC}℃` : `${Math.round((day.maxtempC * 9/5) + 32)}℉`;
                    const temp = `${minTemp}~${maxTemp}`;
                    const desc = day.weatherDesc[0].value || "--";

                    weeklyItem.innerHTML = `
                        <div class="weekly-date">${dateText}</div>
                        <div class="weekly-temp">${temp}</div>
                        <div class="weekly-desc">${desc}</div>
                    `;
                    weeklyList.appendChild(weeklyItem);
                });
            } catch (error) {
                console.error("加载7天预报失败：", error);
                document.getElementById("weekly-list").innerHTML = "<div style='padding: 12px; color: #718096; font-size: 14px;'>获取7天预报失败</div>";
            }
        }

        // ========== 空气质量（AQI）功能（高德地图API，国内稳定） ==========
        async function loadAQI(lng, lat) {
            try {
                // 高德地图空气质量API（免费）
                const aqiRes = await fetch(`https://restapi.amap.com/v3/air/weather/geo?location=${lng},${lat}&output=json&key=e9092f93e5f9f270e869af981b080799`);
                const aqiData = await aqiRes.json();
                
                if (aqiData.status === "1" && aqiData.aircitycode) {
                    const aqiInfo = aqiData.airinfo;
                    const aqi = aqiInfo.aqi;
                    let aqiLevel, aqiClass;
                    
                    // 国内AQI分级标准
                    if (aqi <= 50) {
                        aqiLevel = "优";
                        aqiClass = "aqi-excellent";
                    } else if (aqi <= 100) {
                        aqiLevel = "良";
                        aqiClass = "aqi-good";
                    } else if (aqi <= 150) {
                        aqiLevel = "轻度污染";
                        aqiClass = "aqi-moderate";
                    } else if (aqi <= 200) {
                        aqiLevel = "中度污染";
                        aqiClass = "aqi-poor";
                    } else if (aqi <= 300) {
                        aqiLevel = "重度污染";
                        aqiClass = "aqi-very-poor";
                    } else {
                        aqiLevel = "严重污染";
                        aqiClass = "aqi-hazardous";
                    }

                    const aqiElement = document.getElementById("aqi");
                    aqiElement.textContent = `空气质量：${aqi} (${aqiLevel})`;
                    aqiElement.className = `aqi-info ${aqiClass}`;
                } else {
                    loadAQIFallback();
                }
            } catch (error) {
                console.error("加载AQI失败：", error);
                loadAQIFallback();
            }
        }

        // AQI备用接口（防止主接口失效）
        async function loadAQIFallback() {
            try {
                const res = await fetch(`https://api.waqi.info/feed/${currentCity}/?token=demo`);
                const data = await res.json();
                if (data.status === "ok") {
                    const aqi = data.data.aqi;
                    let aqiLevel, aqiClass;
                    if (aqi <= 50) {
                        aqiLevel = "优";
                        aqiClass = "aqi-excellent";
                    } else if (aqi <= 100) {
                        aqiLevel = "良";
                        aqiClass = "aqi-good";
                    } else if (aqi <= 150) {
                        aqiLevel = "轻度污染";
                        aqiClass = "aqi-moderate";
                    } else if (aqi <= 200) {
                        aqiLevel = "中度污染";
                        aqiClass = "aqi-poor";
                    } else if (aqi <= 300) {
                        aqiLevel = "重度污染";
                        aqiClass = "aqi-very-poor";
                    } else {
                        aqiLevel = "严重污染";
                        aqiClass = "aqi-hazardous";
                    }
                    const aqiElement = document.getElementById("aqi");
                    aqiElement.textContent = `空气质量：${aqi} (${aqiLevel})`;
                    aqiElement.className = `aqi-info ${aqiClass}`;
                } else {
                    document.getElementById("aqi").textContent = "空气质量：暂未获取";
                    document.getElementById("aqi").className = "aqi-info";
                }
            } catch (error) {
                document.getElementById("aqi").textContent = "空气质量：暂未获取";
                document.getElementById("aqi").className = "aqi-info";
            }
        }

        // 初始化页面
        initCalendar();
        initWeather();
    </script>
</body>
</html>
